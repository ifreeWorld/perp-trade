# 对冲策略优化方案总结

## 一、背景与问题

### 当前策略

- Lighter 和 Paradex 两个交易所都是无手续费（市价单和限价单均免费）
- 当前采用双市价单同时开仓、市价平仓的策略
- 开仓时一边做多、一边做空，形成对冲

### 存在的问题

1. **市价单价格磨损**：市价买入总是吃 Ask 价（较高），市价卖出总是吃 Bid 价（较低）
2. **两边价格不一致**：双市价单开仓时，两边成交价格必然不同，开仓即亏损
3. **累积损耗**：每次开仓都有买卖价差（Spread）的损耗，约 0.08-0.10 美元/单

---

## 二、讨论的方案对比

### 方案1：统一价格限价单

**做法**：获取两边中间价的平均值，两边都用相同价格挂限价单

**优点**：

- 价格完全一致，无开仓损耗
- 理想情况下是最优解

**缺点**：

- 成交率低：两边都成交的概率仅 12-20%
- 单边成交风险高：需要快速市价对冲

---

### 方案2：各用各的中间价限价单（✅ 采纳）

**做法**：Paradex 用自己的 Mid 价，Lighter 用自己的 Mid 价，各自挂限价单

**优点**：

- 成交率更高：每边在自己市场的最优位置
- 损耗可控：通常价差仅 0.01-0.05 美元（远小于市价单的 0.08 美元）
- 实现简单：不需要复杂的价格计算
- 风险分散：不会因为统一价格导致某边价格不合理

**缺点**：

- 有小幅价差损耗（但可接受）

**核心逻辑**：
虽然两边价格不完全一致，但损耗远小于市价单，且成交率显著提升。

---

### 方案3：串行开仓（市价→限价）（❌ 否决）

**做法**：先在一边市价开仓，获取成交价后在另一边用该价格挂限价单

**优点**：

- 理想情况下价格完全一致

**缺点**：

- 单边暴露风险高：必然有时间窗口持有单边仓位
- 成交率低：第二边的限价单可能长时间不成交
- 风险收益不对称：市场波动可能导致严重亏损

**结论**：违背对冲策略"同时开仓"的核心原则，不推荐。

---

## 三、最终确定的优化方案

### 核心策略：各用各的中间价 + 限价优先 + 市价兜底

### 关键要素

#### 1. 智能选择开仓方向

**目标**：每次开仓选择成本更低的方向

**方法**：

- 获取 Paradex 和 Lighter 的 Bid/Ask 价格
- 计算两个方向的预期成本：
  - 方向A：Paradex 买入 + Lighter 卖出
  - 方向B：Paradex 卖出 + Lighter 买入
- 选择成本更低的方向

**优势**：自动找到最优价格组合，每单可额外节省成本

---

#### 2. 限价单定价策略

**基准价格**：各用各的中间价（Mid = (Bid + Ask) / 2）

**激进度调整**：

- 第1次尝试：Mid ± 30% Spread（保守，优先节省成本）
- 第2次尝试：Mid ± 50% Spread（中等激进）
- 第3次尝试：Mid ± 70% Spread（激进，更接近市价）

**方向调整**：

- 买入方向：在 Mid 基础上加价（Mid + X% Spread）
- 卖出方向：在 Mid 基础上减价（Mid - X% Spread）

**目的**：平衡成交率和成本，随重试次数逐步提高成交概率

---

#### 3. 价格合理性检查

**检查项**：两边价格差异百分比

**阈值**：如果 Paradex 和 Lighter 的 Mid 价差超过 0.2%

**处理**：直接放弃限价单，改用市价单

**原因**：价差过大说明市场异常，限价单成交率极低

---

#### 4. 三种成交情况处理

##### 情况1：两边都成交（✅ 完美）

**概率**：40-50%

**处理**：

- 验证净持仓是否在合理范围（< 0.02）
- 如有偏差，执行修正
- 完成开仓

**结果**：价格接近一致，成本最优

---

##### 情况2A：Paradex 成交，Lighter 未成交（⚠️ 单边成交）

**概率**：15-20%

**处理**：

- 立即取消 Lighter 限价单
- Lighter 立即市价对冲
- 等待成交确认
- 验证并修正净持仓

**结果**：一边限价 + 一边市价，成本良好

---

##### 情况2B：Lighter 成交，Paradex 未成交（⚠️ 单边成交）

**概率**：15-20%

**处理**：

- 立即取消 Paradex 限价单
- Paradex 立即市价对冲
- 等待成交确认
- 验证并修正净持仓

**结果**：一边限价 + 一边市价，成本良好

---

##### 情况3：两边都未成交（❌ 重试）

**概率**：10-20%（第1次），逐次降低

**处理**：

- 取消两边限价单
- 检查是否有残留持仓（取消期间可能成交）
- 如有残留，立即对冲
- 如确认都未成交：
  - 尝试次数 < 3：重新开限价单（更激进的价格）
  - 尝试次数 = 3：改用市价单兜底

**结果**：通过渐进式重试提高成交率

---

## 四、渐进式重试机制

### 重试策略

最多尝试 3 次限价单，每次价格更激进：

| 尝试次数 | 激进度 | 限价位置         | 预期成交率 | 成本等级 |
| -------- | ------ | ---------------- | ---------- | -------- |
| 第1次    | 30%    | Mid ± 30% Spread | 40%        | 最优     |
| 第2次    | 50%    | Mid ± 50% Spread | 65%        | 良好     |
| 第3次    | 70%    | Mid ± 70% Spread | 85%        | 一般     |
| 兜底     | 100%   | 市价单           | 100%       | 最差     |

### 综合成交概率

- 限价单成交率：约 97%（前3次累积）
- 市价单兜底：3%
- 总体成交率：100%

---

## 五、预期效果分析

### 成本对比

| 策略         | 平均单次损耗 | 每日损耗（100单） | 每月损耗     |
| ------------ | ------------ | ----------------- | ------------ |
| 当前双市价单 | $0.08        | $8                | $240         |
| 优化后方案   | $0.03-0.04   | $3-4              | $90-120      |
| **节省**     | **50%+**     | **$4-5**          | **$120-150** |

### 成交分布预测

| 结果类型            | 概率   | 说明                   |
| ------------------- | ------ | ---------------------- |
| 双限价成交          | 40-50% | 价格最优，损耗约 $0.02 |
| 单边限价 + 单边市价 | 30-40% | 价格良好，损耗约 $0.05 |
| 双市价兜底          | 10-20% | 价格一般，损耗约 $0.08 |

### 关键优势

1. **成本降低**：平均节省 50% 以上的开仓成本
2. **成交保证**：100% 成交率（限价失败后市价兜底）
3. **风险可控**：每个环节都有验证和修正机制
4. **智能优化**：自动选择最优开仓方向

---

## 六、两个市场为什么价格不同步

### 核心原因

Paradex 和 Lighter 是两个完全独立的交易所，就像币安和 OKX：

- 各自有独立的订单簿
- 各自有不同的做市商和交易者
- 各自有不同的流动性深度
- 价格通过套利者保持接近，但不是实时同步

### 微观时刻的差异

1. **流动性提供者不同**：两边的做市商报价策略和更新速度不同
2. **订单流不同**：同一时刻两边的买卖压力不同
3. **网络延迟**：获取价格和下单都有网络延迟
4. **套利时间差**：套利者让价格收敛需要几秒时间

### 为什么会一边成交一边不成交

即使用相同价格挂限价单，两边市场的微观供需不同：

- Paradex 可能有买家正好在那个价位成交
- Lighter 可能没有卖家愿意在那个价位成交
- 这是两个独立市场的正常现象

---

## 七、风险控制机制

### 1. 价差检查

- 开仓前检查两边价差
- 超过阈值（0.2%）直接用市价单
- 避免在市场异常时挂限价单

### 2. 净持仓监控

- 每次开仓后验证净持仓
- 超过容忍度（0.02）立即修正
- 防止单边暴露累积

### 3. 订单超时保护

- 限价单等待时间：1.5 秒
- 超时未成交立即处理
- 避免长时间单边暴露

### 4. 取消确认机制

- 取消订单后等待 500ms
- 再次检查是否有成交
- 防止取消期间的成交被遗漏

### 5. 市价单兜底

- 3 次限价失败后保底
- 保证最终 100% 成交
- 不会出现卡单情况

---

## 八、实施要点

### 关键参数

- **限价单超时**：1500ms（1.5秒）
- **取消等待时间**：500ms
- **最大重试次数**：3次
- **价差阈值**：0.2%
- **净持仓容忍度**：0.02

### 需要的 API 能力

1. 获取订单簿价格（Bid/Ask）
2. 创建限价单
3. 查询订单成交状态
4. 取消订单
5. 创建市价单（兜底）
6. 查询持仓

### 监控指标

- 限价单成交率
- 单边成交频率
- 平均开仓成本
- 重试次数分布
- 净持仓偏差频率

---

## 九、总结

### 方案核心

采用"各用各的中间价 + 限价优先 + 市价兜底 + 智能选方向 + 渐进式重试"的综合策略。

### 主要创新点

1. **各用各的中间价**：适配各自市场，提高成交率
2. **智能选方向**：每次自动选择成本更低的方向
3. **渐进式重试**：3次限价尝试，逐步提高激进度
4. **完善的异常处理**：覆盖所有成交情况

### 预期收益

- 成本降低 50% 以上
- 每月节省约 $120-150
- 限价成交率达到 97%
- 保持 100% 总成交率

### 风险可控

- 每个环节都有验证机制
- 单边成交立即对冲
- 市价单作为最终保底
- 净持仓实时监控和修正

这个方案在保证执行成功率的同时，显著降低了交易成本，适合当前的对冲策略需求。
